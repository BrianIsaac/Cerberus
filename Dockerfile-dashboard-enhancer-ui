# Stage 1: Build dependencies
FROM ghcr.io/astral-sh/uv:python3.11-bookworm-slim AS build

ARG DEBIAN_FRONTEND="noninteractive"

ARG NON_ROOT_USER="dashui"
ARG HOME_DIR="/home/${NON_ROOT_USER}"
ARG REPO_DIR="${HOME_DIR}/app"

RUN mkdir -p ${REPO_DIR}
WORKDIR ${REPO_DIR}

ENV UV_LINK_MODE=copy \
    UV_COMPILE_BYTECODE=1 \
    UV_PYTHON_DOWNLOADS=never

RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    uv sync --locked --no-install-project --no-dev


# Stage 2: Runtime image
FROM ghcr.io/astral-sh/uv:python3.11-bookworm-slim

ARG DEBIAN_FRONTEND="noninteractive"

ARG NON_ROOT_USER="dashui"
ARG NON_ROOT_UID="2228"
ARG NON_ROOT_GID="2228"
ARG HOME_DIR="/home/${NON_ROOT_USER}"
ARG REPO_DIR="${HOME_DIR}/app"

RUN useradd -l -m -s /bin/bash -u ${NON_ROOT_UID} ${NON_ROOT_USER}

RUN apt-get update -qy && \
    apt-get install -qyy --no-install-recommends curl && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

ENV PYTHONIOENCODING=utf8 \
    PYTHONUNBUFFERED=1 \
    LANG="C.UTF-8" \
    LC_ALL="C.UTF-8" \
    PATH="${HOME_DIR}/.local/bin:${REPO_DIR}/.venv/bin:$PATH" \
    PYTHONPATH="${REPO_DIR}" \
    PORT=8080

USER ${NON_ROOT_USER}
WORKDIR ${REPO_DIR}

COPY --from=build --chown=${NON_ROOT_USER}:${NON_ROOT_GID} ${REPO_DIR} ${REPO_DIR}

COPY --chown=${NON_ROOT_USER}:${NON_ROOT_GID} dashboard_enhancer/ dashboard_enhancer/
COPY --chown=${NON_ROOT_USER}:${NON_ROOT_GID} shared/ shared/

EXPOSE 8080

HEALTHCHECK CMD curl --fail http://localhost:8080/_stcore/health || exit 1

ENTRYPOINT ["streamlit", "run", "dashboard_enhancer/app.py", \
    "--server.port=8080", \
    "--server.address=0.0.0.0", \
    "--server.headless=true", \
    "--browser.gatherUsageStats=false"]
